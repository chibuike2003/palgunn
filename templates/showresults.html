<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* --- Print Specific Styles --- */
        @media print {
            /* Hide elements that should not appear in print */
            .no-print {
                display: none !important;
            }

            /* Optimize body for printing */
            body {
                background-color: #fff; /* White background for printing */
                margin: 0;
                padding: 0;
            }

            /* Adjust container to full width for printing */
            .print-area {
                max-width: none;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
            }

            /* Ensure tables and lists print correctly */
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1em;
            }
            th, td {
                border: 1px solid #ddd; /* Light gray border for table cells */
                padding: 8px;
                text-align: left;
                font-size: 10pt; /* Smaller font for print */
            }
            thead {
                background-color: #f2f2f2; /* Light header background */
            }
            h1, h2, h3, h4, h5 {
                text-align: center;
                margin-top: 1em;
                margin-bottom: 0.5em;
                color: #333;
            }
            /* Add page break after each student's results block */
            .student-results-block {
                page-break-after: always; /* Force a page break after each student's block */
                break-after: always; /* For newer browsers */
            }
            .space-y-8 > div {
                page-break-inside: avoid; /* Prevent breaking student/course blocks across pages */
                margin-bottom: 20px; /* Space between blocks */
            }
            ul {
                list-style-type: disc;
                margin-left: 20px;
            }
            li {
                padding-bottom: 5px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-screen-2xl w-full bg-white p-8 rounded-lg shadow-xl print-area">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">Student Exam Results</h1>

        <div class="flex justify-center mb-8 no-print">
            <button onclick="window.print()" id="globalPrintButton"
                    class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5 4V2a2 2 0 012-2h6a2 2 0 012 2v2h2a2 2 0 012 2v8a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h2zm0 2h10v6a2 2 0 01-2 2H7a2 2 0 01-2-2V6zm-2 6h14a2 2 0 002-2V6a2 2 0 00-2-2h-2V2a2 2 0 00-2-2H7a2 2 0 00-2 2v2H3a2 2 0 00-2 2v6a2 2 0 002 2zm12-7a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                    <path d="M11 12a1 1 0 100 2h-2a1 1 0 100-2h2z" />
                </svg>
                Print All Results
            </button>
        </div>
        
        <div id="student-results-view">
            <h2 class="text-3xl font-bold text-gray-700 mb-6">Results by Student</h2>
            <div class="space-y-8">
                {% set student_results = all_results | groupby('reg_number') %}
                {% for reg_number, student_courses in student_results %}
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md border-t-4 border-indigo-500 student-results-block" id="student-{{ reg_number }}">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">{{ student_courses[0].student_name }} ({{ reg_number }})</h3>
                        
                        <div class="flex justify-start space-x-2 mb-4 no-print">
                            <button onclick="downloadStudentReport('{{ reg_number }}')"
                                    class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 01-1-1V6a1 1 0 011-1h14a1 1 0 011 1v10a1 1 0 01-1 1H3zm1-3a1 1 0 011-1h6a1 1 0 010 2H5a1 1 0 01-1-1zm0-3a1 1 0 011-1h6a1 1 0 010 2H5a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                                Download Report
                            </button>
                            <button onclick="printStudentReport('{{ reg_number }}')"
                                    class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 4V2a2 2 0 012-2h6a2 2 0 012 2v2h2a2 2 0 012 2v8a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h2zm0 2h10v6a2 2 0 01-2 2H7a2 2 0 01-2-2V6zm-2 6h14a2 2 0 002-2V6a2 2 0 00-2-2h-2V2a2 2 0 00-2-2H7a2 2 0 00-2 2v2H3a2 2 0 00-2 2v6a2 2 0 002 2zm12-7a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                                    <path d="M11 12a1 1 0 100 2h-2a1 1 0 100-2h2z" />
                                </svg>
                                Print Report
                            </button>
                        </div>

                        {% set student_by_year_semester = student_courses | groupby('course.year') %}
                        {% for year, year_courses in student_by_year_semester %}
                            <div class="mb-6">
                                <h4 class="text-xl font-medium text-gray-700 mb-2">Year {{ year }}</h4>
                                {% set semester_courses = year_courses | groupby('course.semester') %}
                                
                                {% for semester, courses in semester_courses %}
                                
                                    <div class="bg-white p-4 rounded-md shadow-sm mb-4">
                                        <h5 class="text-lg font-bold text-indigo-600 mb-2">Semester {{ semester }}</h5>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                                <thead class="bg-indigo-500">
                                                    <tr>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Course Code</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Course Title</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">CA Score</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Exam Score</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total Score</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Grade</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider no-print">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200">
                                                    {% for course in courses %}
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ course.course.course_code }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ course.course.course_title }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ course.ca_score }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ course.exam_score }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ course.total_score }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                                {% if course.grade == 'A' %}
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">A</span>
                                                                {% elif course.grade == 'B' %}
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">B</span>
                                                                {% elif course.grade == 'C' %}
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">C</span>
                                                                {% elif course.grade == 'D' %}
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">D</span>
                                                                {% elif course.grade == 'E' %}
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">E</span>
                                                                {% else %}
                                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">F</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                                                                <button onclick="openEditModal({{ course.id }})" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                                                                <button onclick="openDeleteConfirmModal({{ course.id }})" class="text-red-600 hover:text-red-900">Delete</button>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>

        ---

        <div id="course-results-view" class="mt-12">
            <h2 class="text-3xl font-bold text-gray-700 mb-6">Results by Course</h2>
            <div class="space-y-8">
                {% set course_results = all_results | groupby('course.course_code') %}
                {% for course_code, results in course_results %}
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md border-t-4 border-purple-500" id="course-block-{{ course_code }}">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">{{ results[0].course.course_title }} ({{ course_code }})</h3>
                        <div class="mb-4">
                            <span class="font-semibold">Year:</span> {{ results[0].course.year }} |
                            <span class="font-semibold">Semester:</span> {{ results[0].course.semester }} |
                            <span class="font-semibold">Session:</span> {{ results[0].course.session_written }}
                        </div>

                        <div class="flex justify-start mb-4 no-print">
                            <button onclick="printAllStudentsForCourse('{{ course_code }}')"
                                    class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 4V2a2 2 0 012-2h6a2 2 0 012 2v2h2a2 2 0 012 2v8a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h2zm0 2h10v6a2 2 0 01-2 2H7a2 2 0 01-2-2V6zm-2 6h14a2 2 0 002-2V6a2 2 0 00-2-2h-2V2a2 2 0 00-2-2H7a2 2 0 00-2 2v2H3a2 2 0 00-2 2v6a2 2 0 002 2zm12-7a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                                    <path d="M11 12a1 1 0 100 2h-2a1 1 0 100-2h2z" />
                                </svg>
                                Print All for Course
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                <thead class="bg-purple-500">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Student Name
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Reg. Number
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            CA Score
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Exam Score
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Total Score
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                                            Grade
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider no-print">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for result in results %}
                                    <tr id="course-result-{{ result.id }}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            {{ result.student_name }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                            {{ result.reg_number }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                            {{ result.ca_score }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                            {{ result.exam_score }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                            {{ result.total_score }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            {% if result.grade == 'A' %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">A</span>
                                            {% elif result.grade == 'B' %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">B</span>
                                            {% elif result.grade == 'C' %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">C</span>
                                            {% elif result.grade == 'D' %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">D</span>
                                            {% elif result.grade == 'E' %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">E</span>
                                            {% else %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">F</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                                            <button onclick="openEditModal({{ result.id }})" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                                            <button onclick="openDeleteConfirmModal({{ result.id }})" class="text-red-600 hover:text-red-900 mr-2">Delete</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        ---
        <!-- New section for grouping by registration number prefix -->
        <div id="group-by-prefix-section" class="mt-12">
            <h2 class="text-3xl font-bold text-gray-700 mb-6">Results by Registration Number Prefix</h2>
            <div id="prefix-results-container" class="space-y-8">
                <!-- Content will be dynamically inserted here by JavaScript -->
            </div>
        </div>
        <!-- End of new section -->

    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Edit Student Result</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editResultId" name="id">

                <div>
                    <label for="editStudentName" class="block text-sm font-medium text-gray-700">Student Name</label>
                    <input type="text" id="editStudentName" name="student_name" required 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 bg-gray-100 cursor-not-allowed">
                </div>
                <div>
                    <label for="editRegNumber" class="block text-sm font-medium text-gray-700">Registration Number</label>
                    <input type="text" id="editRegNumber" name="reg_number" required 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 bg-gray-100 cursor-not-allowed">
                </div>
                <div>
                    <label for="editCourseId" class="block text-sm font-medium text-gray-700">Course ID</label>
                    <input type="number" id="editCourseId" name="course_id" required  readonly
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 bg-gray-100 cursor-not-allowed">
                </div>
                <div>
                    <label for="editCaScore" class="block text-sm font-medium text-gray-700">CA Score</label>
                    <input type="number" id="editCaScore" name="ca_score"  min="0" max="100"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="editExamScore" class="block text-sm font-medium text-gray-700">Exam Score</label>
                    <input type="number" id="editExamScore" name="exam_score"  min="0" max="100"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()"
                                 class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </button>
                    <button type="submit"
                                 class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeDeleteConfirmModal()">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Confirm Deletion</h2>
            <p id="deleteConfirmMessage" class="text-center text-gray-700 mb-6">Are you sure you want to delete this result?</p>
            <div class="flex justify-center space-x-4">
                <button type="button" onclick="closeDeleteConfirmModal()"
                               class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </button>
                <button type="button" id="confirmDeleteButton"
                               class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        // Make sure 'all_results' from Flask is accessible in JavaScript
        // This line is crucial for the JavaScript to receive data from the Flask backend.
        // If Flask does not provide 'all_results' or provides it as 'null', this will be empty or null.
        const allResults = {{ all_results | tojson }};

        // Helper for getting the header string for text files
        const REPORT_HEADER_TEXT = `UNIVERSITY OF NIGERIA, NSUKKA\\nFACULTY OF SOCIAL SCIENCE\\nDEPARTMENT OF PUBLIC ADMINISTRATION AND LOCAL GOVERNMENT\\n\\n`;

        // Helper for getting the header HTML for print windows
        const REPORT_HEADER_HTML = `
            <h1 style="text-align: center; margin-top: 1em; margin-bottom: 0.5em; color: #333; font-size: 2.25rem; font-weight: 800;">UNIVERSITY OF NIGERIA, NSUKKA <br>FACULTY OF SOCIAL SCIENCE <br>DEPARTMENT OF PUBLIC ADMINISTRATION AND LOCAL GOVERNMENT <br></h1>
        `;

        // Function to get numeric order for academic years (handle "first_year", "second_year" etc.)
        function getYearOrder(yearString) {
            const yearMap = {
                "First Year": 1,
                "Second Year": 2,
                "Third Year": 3,
                "Fourth Year": 4,
                "Fifth Year": 5, // Add more as needed
                "Final Year": 99 // Assign a high number for final year
            };
            // Normalize yearString for lookup, e.g., "first_year" to "First Year"
            const normalizedYearString = yearString.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            const parsedInt = parseInt(yearString);
            if (!isNaN(parsedInt)) {
                return parsedInt; // If it's a number (e.g., "2023"), use it directly
            }
            return yearMap[normalizedYearString] || 0; // Use map, default to 0 if not found
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check if allResults is valid before trying to render the prefix section
            if (Array.isArray(allResults) && allResults.length > 0) {
                renderPrefixResults();
            } else {
                const prefixResultsContainer = document.getElementById('prefix-results-container');
                if (prefixResultsContainer) {
                    prefixResultsContainer.innerHTML = '<p class="text-center text-gray-500">No results available to group by registration number prefix.</p>';
                }
            }
        });

        // --- Edit Modal Logic ---
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editResultId = document.getElementById('editResultId');
        const editStudentName = document.getElementById('editStudentName');
        const editRegNumber = document.getElementById('editRegNumber');
        const editCourseId = document.getElementById('editCourseId');
        const editCaScore = document.getElementById('editCaScore');
        const editExamScore = document.getElementById('editExamScore');

        async function openEditModal(resultId) {
            try {
                // Fetch result data from the server
                const response = await fetch(`/get_result/${resultId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                // Populate the form fields
                editResultId.value = result.id;
                editStudentName.value = result.student_name;
                editRegNumber.value = result.reg_number;
                editCourseId.value = result.course_id;
                editCaScore.value = result.ca_score;
                editExamScore.value = result.exam_score;

                // Display the modal
                editModal.style.display = 'flex'; // Use flex to center
            } catch (error) {
                console.error('Error fetching result for edit:', error);
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Failed to load result for editing. Please try again.
                    </div>
                `;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
            }
        }

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        editForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const resultId = editResultId.value;
            const formData = new FormData(editForm);
            const data = Object.fromEntries(formData.entries());

            // Remove readonly fields that shouldn't be sent back for update
            delete data.student_name;
            delete data.reg_number;
            delete data.course_id;

            try {
                const response = await fetch(`/edit_result/${resultId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Flask expects JSON for jsonify response
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                    messageBox.innerHTML = `
                        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            ${result.message}
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds

                    closeEditModal();
                    location.reload(); // Reload the page to reflect changes
                } else {
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                    messageBox.innerHTML = `
                        <div class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            Error: ${result.message}
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
                }
            } catch (error) {
                console.error('Error updating result:', error);
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        An unexpected error occurred while updating the result.
                    </div>
                `;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
            }
        });

        // --- Delete Confirmation Modal Logic ---
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let currentDeleteResultId = null; // To store the ID of the result to be deleted

        function openDeleteConfirmModal(resultId) {
            currentDeleteResultId = resultId;
            deleteConfirmModal.style.display = 'flex'; // Use flex to center
        }

        function closeDeleteConfirmModal() {
            deleteConfirmModal.style.display = 'none';
            currentDeleteResultId = null;
        }

        confirmDeleteButton.addEventListener('click', async function() {
            if (currentDeleteResultId) {
                try {
                    const response = await fetch(`/delete_result/${currentDeleteResultId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json' // Ensure Flask expects JSON
                        }
                    });
                    const result = await response.json();

                    if (result.success) {
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                        messageBox.innerHTML = `
                            <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${result.message}
                            </div>
                        `;
                        document.body.appendChild(messageBox);
                        setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
                        closeDeleteConfirmModal();
                        location.reload(); // Reload the page to reflect deletion
                    } else {
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                        messageBox.innerHTML = `
                            <div class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Error: ${result.message}
                            </div>
                        `;
                        document.body.appendChild(messageBox);
                        setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
                    }
                } catch (error) {
                    console.error('Error deleting result:', error);
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
                    messageBox.innerHTML = `
                        <div class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        An unexpected error occurred while deleting the result.
                    </div>
                `;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
                }
            }
        });

        // Close modals if clicked outside
        window.addEventListener('click', function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteConfirmModal) {
                closeDeleteConfirmModal();
            }
        });

        // Function to download student report
        function downloadStudentReport(regNumber) {
            const studentBlock = document.getElementById(`student-${regNumber}`);
            if (!studentBlock) {
                showMessageBox('Error: Student block not found for report generation.', 'red');
                return;
            }

            let reportContent = REPORT_HEADER_TEXT;
            reportContent += `Student Name: ${studentBlock.querySelector('h3').textContent.split('(')[0].trim()}\\n`;
            reportContent += `Registration Number: ${regNumber}\\n\\n`;
            reportContent += `------------------------------------------------------\\n\\n`;

            // Iterate through years
            // Select only the direct children of .student-results-block that are .mb-6 (year containers)
            studentBlock.querySelectorAll('.student-results-block > .mb-6').forEach(yearBlock => {
                const yearHeading = yearBlock.querySelector('h4');
                let year = 'N/A';
                if (yearHeading) {
                    // Extract the year text, handling cases like "Year 2023" or "Year Second Year"
                    const yearText = yearHeading.textContent.replace('Year ', '').trim();
                    year = yearText; // Keep as string for display in report
                }
                
                reportContent += `ACADEMIC YEAR: ${year}\\n`;
                reportContent += `--------------------\\n\\n`;

                // Iterate through semesters within each year
                yearBlock.querySelectorAll('.bg-white.p-4').forEach(semesterBlock => {
                    const semesterHeading = semesterBlock.querySelector('h5');
                    const semester = semesterHeading ? semesterHeading.textContent.replace('Semester ', '').trim() : 'N/A';
                    reportContent += `  SEMESTER: ${semester}\\n`;
                    reportContent += `  --------------------\\n`;
                    reportContent += `  Course Code | Course Title          | CA | Exam | Total | Grade\\n`;
                    reportContent += `  --------------------------------------------------------------\\n`;


                    // Iterate through table rows within each semester
                    const rows = semesterBlock.querySelectorAll('table tbody tr');
                    if (rows.length === 0) {
                        reportContent += `  No courses recorded for this semester.\\n`;
                    } else {
                        rows.forEach(row => {
                            const cols = row.querySelectorAll('td');
                            // Ensure enough columns for course code, title, ca, exam, total, grade
                            if (cols.length >= 6) { 
                                const courseCode = cols[0].textContent.trim().padEnd(12);
                                const courseTitle = cols[1].textContent.trim().padEnd(25);
                                const caScore = cols[2].textContent.trim().padEnd(4);
                                const examScore = cols[3].textContent.trim().padEnd(6);
                                const totalScore = cols[4].textContent.trim().padEnd(7);
                                const grade = cols[5].querySelector('span') ? cols[5].querySelector('span').textContent.trim() : 'N/A';
                                
                                reportContent += `  ${courseCode}|${courseTitle}|${caScore}|${examScore}|${totalScore}|${grade}\\n`;
                            }
                        });
                    }
                    reportContent += `  --------------------------------------------------------------\\n\\n`; // Add a newline after each semester block for readability
                });
                reportContent += `\\n\\n`; // Add a newline after each year block
            });

            const filename = `student_report_${regNumber}.txt`;
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the URL object

            showMessageBox('Student report downloaded successfully!', 'green');
        }

        // Function to print a single student's report in a new window
        function printStudentReport(regNumber) {
            const studentBlock = document.getElementById(`student-${regNumber}`);
            if (!studentBlock) {
                showMessageBox('Error: Student block not found for printing.', 'red');
                return;
            }

            // Get the student's name for the print title
            const studentName = studentBlock.querySelector('h3').textContent.split('(')[0].trim();
            const studentRegNumber = regNumber; // Already available from parameter

            // Create content for the new print window
            let printContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Student Report - ${studentName}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; }
                        h1 { text-align: center; margin-top: 1em; margin-bottom: 0.5em; color: #333; font-size: 2.25rem; font-weight: 800; }
                        h2 { text-align: center; margin-bottom: 1em; color: #4a5568; font-size: 1.875rem; font-weight: 700; }
                        h3 { font-size: 1.5rem; font-weight: 600; color: #2d3748; margin-bottom: 0.75rem; }
                        h4 { font-size: 1.25rem; font-weight: 500; color: #4a5568; margin-bottom: 0.5rem; }
                        h5 { font-size: 1.125rem; font-weight: 700; color: #4c51bf; margin-bottom: 0.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 1em; border-radius: 0.5rem; overflow: hidden; }
                        th, td { border: 1px solid #e2e8f0; padding: 12px 16px; text-align: left; font-size: 0.875rem; }
                        thead { background-color: #4c51bf; color: white; }
                        tbody tr:nth-child(even) { background-color: #f7fafc; }
                        tbody tr:hover { background-color: #edf2f7; }
                        .grade-A { background-color: #d1fae5; color: #065f46; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-B { background-color: #dbeafe; color: #1e40af; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-C { background-color: #fffbeb; color: #92400e; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-D { background-color: #ffedd5; color: #9a3412; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-E { background-color: #ede9fe; color: #6d28d9; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-F { background-color: #fee2e2; color: #991b1b; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .no-courses-message { text-align: center; color: #666; font-style: italic; margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; }
                        hr { border: none; border-top: 1px solid #ccc; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    ${REPORT_HEADER_HTML}
                    <h2>Student Report for ${studentName} (${studentRegNumber})</h2>
                    <hr/>
                    <div class="report-content">
            `;

            studentBlock.querySelectorAll('.mb-6').forEach(yearBlock => {
                const yearHeading = yearBlock.querySelector('h4');
                if (yearHeading) {
                    printContent += `<h3>${yearHeading.textContent}</h3>`; // Use H3 for year
                }

                yearBlock.querySelectorAll('.bg-white.p-4').forEach(semesterBlock => {
                    const semesterHeading = semesterBlock.querySelector('h5');
                    if (semesterHeading) {
                        printContent += `<h4>${semesterHeading.textContent}</h4>`; // Use H4 for semester
                    }

                    const table = semesterBlock.querySelector('table');
                    if (table) {
                        // Create a temporary div to hold the cloned table
                        const tempDiv = document.createElement('div');
                        const clonedTable = table.cloneNode(true);

                        // Remove the last th (Actions) from the cloned table header
                        const headerRow = clonedTable.querySelector('thead tr');
                        if (headerRow) {
                            const lastTh = headerRow.lastElementChild;
                            if (lastTh && lastTh.textContent.trim() === 'Actions') { // Ensure it's the actions header
                                lastTh.remove();
                            }
                        }
                        // Remove the last td (Actions button) from each row in the cloned table body
                        clonedTable.querySelectorAll('tbody tr').forEach(row => {
                            const lastTd = row.lastElementChild;
                            // Check if the last td contains buttons (as a heuristic for actions column)
                            if (lastTd && (lastTd.querySelector('button') || lastTd.classList.contains('no-print'))) {
                                lastTd.remove();
                            }
                            // Fix grade span class for direct print
                            const gradeSpan = row.querySelector('td:nth-child(6) span'); // Assuming grade is 6th column, adjust if needed
                            if (gradeSpan) {
                                // Remove existing bg- and text- classes to avoid conflicts
                                gradeSpan.classList.remove('bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800', 'bg-orange-100', 'text-orange-800', 'bg-purple-100', 'text-purple-800', 'bg-red-100', 'text-red-800');
                                gradeSpan.classList.add(`grade-${gradeSpan.textContent.trim()}`);
                            }
                        });
                        tempDiv.appendChild(clonedTable);
                        printContent += tempDiv.innerHTML; // Get the HTML content
                    } else {
                         printContent += `<p class="no-courses-message">No courses recorded for this semester.</p>`;
                    }
                });
            });

            printContent += `
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close(); // Close the document to ensure content is loaded

            // Give browser a moment to render before printing
            printWindow.onload = function() {
                printWindow.focus(); // Focus the new window
                printWindow.print(); // Trigger print dialog
            };

            showMessageBox(`Opening print preview for ${studentName}.`, 'green');
        }

        // Function to print all students' results for a given course
        function printAllStudentsForCourse(courseCode) {
            const courseBlock = document.getElementById(`course-block-${courseCode}`);
            if (!courseBlock) {
                showMessageBox('Error: Course block not found for printing.', 'red');
                return;
            }

            const courseTitle = courseBlock.querySelector('h3').textContent.split('(')[0].trim();
            const courseYear = courseBlock.querySelector('.mb-4 span:nth-of-type(2)') ? courseBlock.querySelector('.mb-4 span:nth-of-type(2)').textContent.trim() : 'N/A';
            const courseSemester = courseBlock.querySelector('.mb-4 span:nth-of-type(4)') ? courseBlock.querySelector('.mb-4 span:nth-of-type(4)').textContent.trim() : 'N/A';
            const courseSession = courseBlock.querySelector('.mb-4 span:nth-of-type(6)') ? courseBlock.querySelector('.mb-4 span:nth-of-type(6)').textContent.trim() : 'N/A';


            let printContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Students for Course - ${courseTitle}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; }
                        h1 { text-align: center; margin-top: 1em; margin-bottom: 0.5em; color: #333; font-size: 2.25rem; font-weight: 800; }
                        h2 { text-align: center; margin-bottom: 1em; color: #4a5568; font-size: 1.875rem; font-weight: 700; }
                        h3 { font-size: 1.5rem; font-weight: 600; color: #2d3748; margin-bottom: 0.75rem; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 1em; border-radius: 0.5rem; overflow: hidden; }
                        th, td { border: 1px solid #e2e8f0; padding: 12px 16px; text-align: left; font-size: 0.875rem; }
                        thead { background-color: #4c51bf; color: white; }
                        tbody tr:nth-child(even) { background-color: #f7fafc; }
                        tbody tr:hover { background-color: #edf2f7; }
                        .grade-A { background-color: #d1fae5; color: #065f46; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-B { background-color: #dbeafe; color: #1e40af; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-C { background-color: #fffbeb; color: #92400e; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-D { background-color: #ffedd5; color: #9a3412; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-E { background-color: #ede9fe; color: #6d28d9; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-F { background-color: #fee2e2; color: #991b1b; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        hr { border: none; border-top: 1px solid #ccc; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    ${REPORT_HEADER_HTML}
                    <h2>${courseTitle} (${courseCode})</h2>
                    <h3>Year: ${courseYear} | Semester: ${courseSemester} | Session: ${courseSession}</h3>
                    <hr/>
                    <table>
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Reg. Number</th>
                                <th>CA Score</th>
                                <th>Exam Score</th>
                                <th>Total Score</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const rows = courseBlock.querySelectorAll('table tbody tr');
            if (rows.length === 0) {
                printContent += `<tr><td colspan="6" style="text-align: center; font-style: italic;">No students recorded for this course.</td></tr>`;
            } else {
                rows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    if (cols.length >= 6) { // Ensure enough columns for data
                        const studentName = cols[0].textContent.trim();
                        const regNumber = cols[1].textContent.trim();
                        const caScore = cols[2].textContent.trim();
                        const examScore = cols[3].textContent.trim();
                        const totalScore = cols[4].textContent.trim();
                        const gradeSpan = cols[5].querySelector('span');
                        const grade = gradeSpan ? gradeSpan.textContent.trim() : 'N/A';

                        printContent += `
                            <tr>
                                <td>${studentName}</td>
                                <td>${regNumber}</td>
                                <td>${caScore}</td>
                                <td>${examScore}</td>
                                <td>${totalScore}</td>
                                <td><span class="grade-${grade}">${grade}</span></td>
                            </tr>
                        `;
                    }
                });
            }

            printContent += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();

            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };

            showMessageBox(`Opening print preview for all students in ${courseCode}.`, 'green');
        }

        // Function to render the new section grouped by registration number prefix
        function renderPrefixResults() {
            const prefixResultsContainer = document.getElementById('prefix-results-container');
            if (!prefixResultsContainer) return;

            // Grouping logic for all results by the first 4 digits of reg_number
            const groupedByPrefix = {};
            // Ensure allResults is an array before trying to iterate
            if (Array.isArray(allResults)) { 
                allResults.forEach(result => {
                    if (result.reg_number && result.reg_number.length >= 4) {
                        const prefix = result.reg_number.substring(0, 4);
                        if (!groupedByPrefix[prefix]) {
                            groupedByPrefix[prefix] = {}; // Nested object to store students by their full reg_number
                        }
                        if (!groupedByPrefix[prefix][result.reg_number]) {
                            groupedByPrefix[prefix][result.reg_number] = {
                                student_name: result.student_name,
                                reg_number: result.reg_number,
                                courses: []
                            };
                        }
                        groupedByPrefix[prefix][result.reg_number].courses.push(result);
                    }
                });
            } else {
                prefixResultsContainer.innerHTML = '<p class="text-center text-gray-500">No results available to group by registration number prefix.</p>';
                return; // Exit if no valid data
            }

            // Sort prefixes for consistent display
            const sortedPrefixes = Object.keys(groupedByPrefix).sort();

            sortedPrefixes.forEach(prefix => {
                const prefixBlock = document.createElement('div');
                prefixBlock.className = 'bg-gray-50 p-6 rounded-lg shadow-md border-t-4 border-teal-500';
                prefixBlock.id = `prefix-block-${prefix}`;

                let studentsHtml = '';
                // Sort students alphabetically by name within each prefix group
                const studentsInPrefix = Object.values(groupedByPrefix[prefix]).sort((a, b) => a.student_name.localeCompare(b.student_name));

                studentsInPrefix.forEach(studentData => {
                    let coursesHtml = '';
                    // Group courses by year and then semester for each student
                    const coursesByYear = {};
                    studentData.courses.forEach(course => {
                        const year = course.course.year || 'Unknown Year';
                        const semester = course.course.semester || 'Unknown Semester';
                        if (!coursesByYear[year]) {
                            coursesByYear[year] = {};
                        }
                        if (!coursesByYear[year][semester]) {
                            coursesByYear[year][semester] = [];
                        }
                        coursesByYear[year][semester].push(course);
                    });

                    // Sort years and semesters
                    const sortedYears = Object.keys(coursesByYear).sort((a, b) => getYearOrder(a) - getYearOrder(b));

                    if (sortedYears.length === 0) {
                        coursesHtml = 'No courses recorded.';
                    } else {
                        sortedYears.forEach(year => {
                            coursesHtml += `<h4 class="text-lg font-semibold text-gray-700 mt-3">Year ${year}</h4>`;
                            const sortedSemesters = Object.keys(coursesByYear[year]).sort((a, b) => {
                                const semesterOrder = { "First": 1, "Second": 2 }; // Ensure consistency with defined map
                                return (semesterOrder[a] || 0) - (semesterOrder[b] || 0);
                            });

                            sortedSemesters.forEach(semester => {
                                coursesHtml += `<h5 class="text-md font-medium text-indigo-600 ml-4">Semester ${semester}</h5>`;
                                coursesByYear[year][semester].forEach(course => {
                                    coursesHtml += `
                                        <div class="ml-8 text-sm text-gray-700">
                                            <strong>${course.course.course_code}</strong> - ${course.course.course_title} (CA:${course.ca_score}, Exam:${course.exam_score}, Total:${course.total_score}, Grade:${course.grade})
                                        </div>
                                    `;
                                });
                            });
                        });
                    }

                    studentsHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${studentData.student_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${studentData.reg_number}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${coursesHtml}</td>
                        </tr>
                    `;
                });

                prefixBlock.innerHTML = `
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Students with Registration Prefix: ${prefix}</h3>
                    <div class="flex justify-start space-x-2 mb-4 no-print">
                        <button onclick="downloadPrefixReport('${prefix}')"
                                class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 01-1-1V6a1 1 0 011-1h14a1 1 0 011 1v10a1 1 0 01-1 1H3zm1-3a1 1 0 011-1h6a1 1 0 010 2H5a1 1 0 01-1-1zm0-3a1 1 0 011-1h6a1 1 0 010 2H5a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                            Download All for Prefix
                        </button>
                        <button onclick="printPrefixReport('${prefix}')"
                                class="ml-2 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4V2a2 2 0 012-2h6a2 2 0 012 2v2h2a2 2 0 012 2v8a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h2zm0 2h10v6a2 2 0 01-2 2H7a2 2 0 01-2-2V6zm-2 6h14a2 2 0 002-2V6a2 2 0 00-2-2h-2V2a2 2 0 00-2-2H7a2 2 0 00-2 2v2H3a2 2 0 00-2 2v6a2 2 0 002 2zm12-7a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                                <path d="M11 12a1 1 0 100 2h-2a1 1 0 100-2h2z" />
                            </svg>
                            Print All for Prefix
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-teal-500">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Student Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Reg. Number</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">All Courses (Code - Title - CA/Exam/Total/Grade)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${studentsHtml}
                            </tbody>
                        </table>
                    </div>
                `;
                prefixResultsContainer.appendChild(prefixBlock);
            });
        }

        // New function to download all students for a given prefix
        function downloadPrefixReport(prefix) {
            const groupedByPrefix = {};
            if (Array.isArray(allResults)) {
                allResults.forEach(result => {
                    if (result.reg_number && result.reg_number.length >= 4) {
                        const currentPrefix = result.reg_number.substring(0, 4);
                        if (currentPrefix === prefix) {
                            if (!groupedByPrefix[result.reg_number]) {
                                groupedByPrefix[result.reg_number] = {
                                    student_name: result.student_name,
                                    reg_number: result.reg_number,
                                    courses: []
                                };
                            }
                            groupedByPrefix[result.reg_number].courses.push(result);
                        }
                    }
                });
            } else {
                showMessageBox('No student data available to download.', 'red');
                return;
            }

            let reportContent = REPORT_HEADER_TEXT;
            reportContent += `REPORT FOR REGISTRATION NUMBER PREFIX: ${prefix}\\n\\n`;
            reportContent += `------------------------------------------------------\\n\\n`;

            // Sort students alphabetically by name
            const sortedStudentRegNumbers = Object.keys(groupedByPrefix).sort((a,b) => groupedByPrefix[a].student_name.localeCompare(groupedByPrefix[b].student_name));

            sortedStudentRegNumbers.forEach(regNumber => {
                const studentData = groupedByPrefix[regNumber];
                reportContent += `Student Name: ${studentData.student_name}\\n`;
                reportContent += `Registration Number: ${studentData.reg_number}\\n`;
                
                // Group courses by year and then semester for each student
                const coursesByYear = {};
                studentData.courses.forEach(course => {
                    const year = course.course.year || 'Unknown Year';
                    const semester = course.course.semester || 'Unknown Semester';
                    if (!coursesByYear[year]) {
                        coursesByYear[year] = {};
                    }
                    if (!coursesByYear[year][semester]) {
                        coursesByYear[year][semester] = [];
                    }
                    coursesByYear[year][semester].push(course);
                });

                // Sort years and semesters
                const sortedYears = Object.keys(coursesByYear).sort((a, b) => getYearOrder(a) - getYearOrder(b));

                if (sortedYears.length === 0) {
                    reportContent += `  No courses recorded for this student.\\n`;
                } else {
                    sortedYears.forEach(year => {
                        reportContent += `  Year: ${year}\\n`;
                        const sortedSemesters = Object.keys(coursesByYear[year]).sort((a, b) => {
                            const semesterOrder = { "First": 1, "Second": 2 };
                            return (semesterOrder[a] || 0) - (semesterOrder[b] || 0);
                        });

                        sortedSemesters.forEach(semester => {
                            reportContent += `    Semester: ${semester}\\n`;
                            coursesByYear[year][semester].forEach(course => {
                                reportContent += `    - ${course.course.course_code} - ${course.course.course_title} (CA:${course.ca_score}, Exam:${course.exam_score}, Total:${course.total_score}, Grade:${course.grade})\\n`;
                            });
                        });
                    });
                }
                reportContent += `\\n`; // Spacer between students
            });

            const filename = `students_by_prefix_${prefix}.txt`;
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessageBox(`Report for prefix ${prefix} downloaded successfully!`, 'green');
        }

        // New function to print all students for a given prefix
        function printPrefixReport(prefix) {
            const groupedByPrefix = {};
            if (Array.isArray(allResults)) {
                allResults.forEach(result => {
                    if (result.reg_number && result.reg_number.length >= 4) {
                        const currentPrefix = result.reg_number.substring(0, 4);
                        if (currentPrefix === prefix) {
                            if (!groupedByPrefix[result.reg_number]) {
                                groupedByPrefix[result.reg_number] = {
                                    student_name: result.student_name,
                                    reg_number: result.reg_number,
                                    courses: []
                                };
                            }
                            groupedByPrefix[result.reg_number].courses.push(result);
                        }
                    }
                });
            } else {
                showMessageBox('No student data available to print.', 'red');
                return;
            }

            let printContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Students for Prefix - ${prefix}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; }
                        h1 { text-align: center; margin-top: 1em; margin-bottom: 0.5em; color: #333; font-size: 2.25rem; font-weight: 800; }
                        h2 { text-align: center; margin-bottom: 1em; color: #4a5568; font-size: 1.875rem; font-weight: 700; }
                        h3 { font-size: 1.5rem; font-weight: 600; color: #2d3748; margin-bottom: 0.75rem; }
                        h4 { font-size: 1.25rem; font-weight: 500; color: #4a5568; margin-bottom: 0.5rem; }
                        p { margin-bottom: 0.5em; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 1em; border-radius: 0.5rem; overflow: hidden; }
                        th, td { border: 1px solid #e2e8f0; padding: 12px 16px; text-align: left; font-size: 0.875rem; }
                        thead { background-color: #4c51bf; color: white; }
                        tbody tr:nth-child(even) { background-color: #f7fafc; }
                        tbody tr:hover { background-color: #edf2f7; }
                        .grade-A { background-color: #d1fae5; color: #065f46; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-B { background-color: #dbeafe; color: #1e40af; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-C { background-color: #fffbeb; color: #92400e; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-D { background-color: #ffedd5; color: #9a3412; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-E { background-color: #ede9fe; color: #6d28d9; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .grade-F { background-color: #fee2e2; color: #991b1b; border-radius: 9999px; padding: 2px 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; justify-content: center; align-items: center; white-space: nowrap; }
                        .no-courses-message { text-align: center; color: #666; font-style: italic; margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; }
                        hr { border: none; border-top: 1px solid #ccc; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    ${REPORT_HEADER_HTML}
                    <h2>Student Results for Registration Number Prefix: ${prefix}</h2>
                    <hr/>
                    <table>
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Reg. Number</th>
                                <th>Course Details</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Sort students alphabetically by name
            const sortedStudentRegNumbers = Object.keys(groupedByPrefix).sort((a,b) => groupedByPrefix[a].student_name.localeCompare(groupedByPrefix[b].student_name));

            sortedStudentRegNumbers.forEach(regNumber => {
                const studentData = groupedByPrefix[regNumber];
                let coursesDetailsHtml = '';

                // Group courses by year and then semester for each student
                const coursesByYear = {};
                studentData.courses.forEach(course => {
                    const year = course.course.year || 'Unknown Year';
                    const semester = course.course.semester || 'Unknown Semester';
                    if (!coursesByYear[year]) {
                        coursesByYear[year] = {};
                    }
                    if (!coursesByYear[year][semester]) {
                        coursesByYear[year][semester] = [];
                    }
                    coursesByYear[year][semester].push(course);
                });

                // Sort years and semesters
                const sortedYears = Object.keys(coursesByYear).sort((a, b) => getYearOrder(a) - getYearOrder(b));

                if (sortedYears.length === 0) {
                    coursesDetailsHtml = `<div class="no-courses-message">No courses recorded for this student.</div>`;
                } else {
                    sortedYears.forEach(year => {
                        coursesDetailsHtml += `<h4>Year: ${year}</h4>`;
                        const sortedSemesters = Object.keys(coursesByYear[year]).sort((a, b) => {
                            const semesterOrder = { "First": 1, "Second": 2 };
                            return (semesterOrder[a] || 0) - (semesterOrder[b] || 0);
                        });

                        sortedSemesters.forEach(semester => {
                            coursesDetailsHtml += `<h5>Semester: ${semester}</h5>`;
                            coursesByYear[year][semester].forEach(course => {
                                coursesDetailsHtml += `
                                    <p>
                                        <strong>${course.course.course_code}</strong> - ${course.course.course_title} (CA:${course.ca_score}, Exam:${course.exam_score}, Total:${course.total_score}, Grade:<span class="grade-${course.grade}">${course.grade}</span>)
                                    </p>
                                `;
                            });
                        });
                    });
                }

                printContent += `
                    <tr>
                        <td>${studentData.student_name}</td>
                        <td>${studentData.reg_number}</td>
                        <td>${coursesDetailsHtml}</td>
                    </tr>
                `;
            });

            printContent += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();

            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };

            showMessageBox(`Opening print preview for students with prefix ${prefix}.`, 'green');
        }

        // Ensure the showMessageBox function is defined
        function showMessageBox(message, type) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 flex items-center justify-center z-50';
            let bgColor = '';
            let iconSvg = '';

            if (type === 'green') {
                bgColor = 'bg-green-500';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>`;
            } else if (type === 'red') {
                bgColor = 'bg-red-500';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>`;
            }

            messageBox.innerHTML = `
                <div class="${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center">
                    ${iconSvg}
                    ${message}
                </div>
            `;
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), 3000); // Remove after 3 seconds
        }
    </script>
</body>
</html>
