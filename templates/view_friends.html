<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Dashboard</title> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f0f2f5;
            font-family: 'Poppins', sans-serif;
        }
        .page-title {
            font-weight: 700;
            color: #343a40;
            margin-bottom: 3rem; /* Adjusted for better spacing */
        }
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            height: 100%; /* Ensure cards are same height */
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
        .avatar-lg {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .item-name { /* Renamed from friend-name for generality */
            font-size: 1.2rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 5px;
        }
        .item-description { /* Renamed from friend-username */
            font-size: 0.95rem;
            color: #6c757d;
            margin-bottom: 15px;
        }
        .btn-action, .btn-secondary-action { /* Renamed from btn-chat/profile */
            margin: 5px 0;
            border-radius: 50px;
            width: 100%;
            padding: 8px;
            font-weight: 500;
            text-decoration: none; /* Ensure anchor tags look like buttons */
            display: inline-block; /* Ensure anchor tags take full width */
            text-align: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-action {
            background-color: #0d6efd;
            color: #fff;
        }
        .btn-action:hover {
            background-color: #0b5ed7;
            color: #fff; /* Keep text white on hover */
        }
        .btn-secondary-action {
            background-color: #6c63ff;
            color: #fff;
        }
        .btn-secondary-action:hover {
            background-color: #5a54d1;
            color: #fff; /* Keep text white on hover */
        }
        .back-btn {
            background-color: #6c63ff;
            color: #fff;
            border: none;
            padding: 10px 25px;
            font-weight: 500;
            border-radius: 50px;
            transition: background-color 0.3s;
            text-decoration: none; /* For the anchor tag */
        }
        .back-btn:hover {
            background-color: #5a54d1;
            color: #fff; /* Keep text white on hover */
        }
        /* Visibility badge styling */
        .visibility-badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
            margin-top: 10px;
        }
        .visibility-public {
            background-color: #28a745; /* Green */
            color: #fff;
        }
        .visibility-private {
            background-color: #dc3545; /* Red */
            color: #fff;
        }
    </style>
</head>
<body>

    <div class="container my-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="text-sm px-4 py-2 rounded text-white {{ 'bg-red-500' if category == 'danger' else 'bg-green-500' }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="page-title">My Friends</h2>
        </div>
        <div class="row justify-content-center">
            {% if friends %} {# This block is now part of the row #}
                {% for friend in friends %}
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                        <div class="card text-center p-4">
                            <img src="https://picsum.photos/600/400?random=1" alt="Random placeholder image" class="avatar-lg">  
                            <div class="card-body d-flex flex-column">
                                <h5 class="item-name">{{ friend.fullname }}</h5>
                                <p class="item-description">@{{ friend.username }}</p> {# Assuming 'username' exists #}
        
                                <!-- <a href="{{ url_for('privatechat', friend_id=friend.id) }}" class="btn-action mt-auto">Chat Now</a> -->
        
                                <a href="#" class="btn-secondary-action mt-2 view-profile-btn"
                                   data-bs-toggle="modal"
                                   data-bs-target="#userProfileModal"
                                   data-user-id="{{ friend.id }}">View Profile</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %} {# This 'else' now covers the entire row if no friends are found #}
                <div class="text-center col-12">
                    <p class="text-muted">You have no friends yet ðŸ˜¢.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                    <div class="modal-header" style="background-color: #6a11cb; background-image: linear-gradient(to right, #2575fc, #6a11cb); color: white; border-bottom: none; padding: 20px;">
                        <h5 class="modal-title" id="userProfileModalLabel" style="font-size: 1.8rem; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">User Profile</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                    </div>
                    <div class="modal-body text-center" style="padding: 30px; background-color: #f8f9fa;">
                        <div id="modal-content-placeholder">
                            <p style="color: #6c757d; font-style: italic;">Loading user data...</p>
                        </div>
                    </div>
                    <div class="modal-footer" style="background-color: #e9ecef; border-top: none; padding: 15px 20px; justify-content: center;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #6c757d; border-color: #6c757d; border-radius: 20px; padding: 8px 25px; font-weight: bold;">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const userProfileModal = document.getElementById('userProfileModal');
                userProfileModal.addEventListener('show.bs.modal', function (event) {
                    // Button that triggered the modal
                    const button = event.relatedTarget;
                    // Extract info from data-user-id attributes
                    const userId = button.getAttribute('data-user-id');
        
                    const modalContentPlaceholder = userProfileModal.querySelector('#modal-content-placeholder');
                    modalContentPlaceholder.innerHTML = '<p style="color: #6c757d; font-style: italic;">Loading user data...</p>'; // Show loading message
        
                    // Make an AJAX request to fetch user data
                    fetch(`/get_user_profile/${userId}`) // You'll create this Flask endpoint
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.error) {
                                modalContentPlaceholder.innerHTML = `<p style="color: #dc3545; font-weight: bold;">${data.error}</p>`;
                            } else {
                                // Populate the modal with the fetched data
                                modalContentPlaceholder.innerHTML = `
                                    <img src="${data.profile_picture_url}" class="avatar-lg mb-3" alt="${data.fullname}"
                                         style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid #2575fc; box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);">
                                    <h5 style="color: #343a40; font-size: 1.7rem; margin-top: 15px; margin-bottom: 5px;">${data.fullname}</h5>
                                    <p style="color: #6c757d; font-size: 1rem; margin-bottom: 5px;"><strong style="color: #495057;">Email:</strong> ${data.email}</p>
                                    <p style="color: #6c757d; font-size: 1rem; margin-bottom: 5px;"><strong style="color: #495057;">Reg No:</strong> ${data.regno}</p>
                                    <p style="color: #6c757d; font-size: 1rem;"><strong style="color: #495057;">Phone:</strong> ${data.phone}</p>
                                    `;
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching user profile:', error);
                            modalContentPlaceholder.innerHTML = '<p style="color: #dc3545; font-weight: bold;">Could not load user profile. Please try again.</p>';
                        });
                });
            });
        </script>

        <div class="d-flex justify-content-between align-items-center mb-4 mt-5">
            <h2 class="page-title">My Projects</h2>
            <a href="{{ url_for('upload_project') }}" class="btn back-btn">Upload New Project</a>
        </div>

        <div class="row justify-content-center">
            {# Loop through projects passed from Flask context #}
            {% for project in projects %}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                    <div class="card text-center p-4">
                        <img src="{{ url_for('static', filename='project_placeholder.jpg') }}" class="avatar-lg" alt="{{ project.title }}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="item-name">{{ project.title }}</h5>
                            <p class="item-description">{{ project.description[:70] }}...</p> <span class="visibility-badge {% if project.is_public %}visibility-public{% else %}visibility-private{% endif %}">
                                {% if project.is_public %}Public{% else %}Private{% endif %}
                            </span>

                            <a href="{{ url_for('view_project', project_id=project.id) }}" class="btn-action mt-auto">View Details</a>

                            <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn-secondary-action mt-2">Manage Project</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center col-12">
                    <p class="text-muted">You haven't uploaded any projects yet. Start sharing your ideas! ðŸš€</p>
                </div>
            {% endfor %}
        </div>

        ---
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4 mt-5">
                <h2 class="page-title">My Communities</h2>
                <a href="{{ url_for('create_community') }}" class="btn back-btn">Create Community</a>
            </div>
    
            <div class="row justify-content-center">
                {% for community in communities %}
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                        <div class="card text-center p-4">
                            <img src="https://picsum.photos/600/400?random=1" alt="Random placeholder image" class="avatar-lg">  
                            <div class="card-body d-flex flex-column">
                                <h5 class="item-name">{{ community.name }}</h5>
                                <p class="item-description">Created by @{{ community.creator_username }}</p>
    
                                <a href="{{ url_for('view_community', community_id=community.id) }}" class="btn-action mt-auto">View Community</a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center col-12">
                        <p class="text-muted">No communities have been created by you yet ðŸ˜¢. Why not create one?</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    
        <div class="text-center mt-5">
            <a href="{{ url_for('friendrequest') }}" class="btn back-btn">Back to Friend Requests</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>