<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background: #f8f F;
            font-family: 'Inter', sans-serif;
        }

        .dashboard-header {
            background-color: #0d6efd;
            color: white;
            padding: 20px 0;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-weight: bold;
        }

        .modal-table th {
            background-color: #0d6efd;
            color: white;
        }

        .card-style {
            transition: transform 0.2s ease;
            cursor: pointer;
            height: 100%; /* Ensure uniform height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .card-style:hover {
            transform: scale(1.02);
        }

        .modal-content {
            border-radius: 15px;
        }

        .modal-header {
            background-color: #0d6efd;
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        
        /* Make close button work with dark header */
        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #f2f7ff;
        }
        
        .card-container {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>

<div class="dashboard-header">
    <h1>üìä Admin Dashboard</h1>
    <p class="lead">Manage candidates, users, and results efficiently</p>
</div>

<div class="container card-container">
    <div class="row text-center g-4">
        {# Row 1: Users, Voters, Dues Payers #}
        <div class="col-md-3">
            <div class="card card-style shadow-sm p-4" data-bs-toggle="modal" data-bs-target="#modalOne">
                <h5 class="text-primary fw-bold">Users On The Platform</h5>
                <p class="text-muted">List of all registered Students</p>
                <h2 class="display-5 text-primary">{% if users %}{{ users|length }}{% else %}0{% endif %}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-style shadow-sm p-4" data-bs-toggle="modal" data-bs-target="#modalTwo">
                <h5 class="text-primary fw-bold">People That Voted</h5>
                <p class="text-muted">Voters that Exercised Their Franchise</p>
                <h2 class="display-5 text-primary">{% if voters %}{{ voters|length }}{% else %}0{% endif %}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-style shadow-sm p-4" data-bs-toggle="modal" data-bs-target="#modalThree">
                <h5 class="text-primary fw-bold">Dues Payers</h5>
                <p class="text-muted">Departmental Dues History</p>
                <h2 class="display-5 text-primary">{% if dues_payers %}{{ dues_payers|length }}{% else %}0{% endif %}</h2>
            </div>
        </div>
        
        {# Lecturer Card #}
        <div class="col-md-3">
            <div class="card card-style shadow-sm p-4" data-bs-toggle="modal" data-bs-target="#modalLecturers">
                <h5 class="text-primary fw-bold">Registered Lecturers</h5>
                <p class="text-muted">View all lecturers who created an account</p>
                <h2 class="display-5 text-primary">{% if lecturers %}{{ lecturers|length }}{% else %}0{% endif %}</h2>
            </div>
        </div>
        {# End Lecturer Card #}

    </div>
</div>

<div class="container py-5">
    <div class="row g-4">
        <hr class="mt-0">
        
        {# --- 1. Manage Users (Students) --- #}
        <h2 class="mt-5 mb-3">Manage Users (Students)</h2>
        <div class="col-12">
            <div class="card dashboard-card p-4 shadow">
                <div class="card-body">
                    <h5 class="card-title">All Registered Users (Students)</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Full Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.fullname }}</td> 
                                    <td>
                                        <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" class="btn btn-warning btn-sm me-2">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        <form action="{{ url_for('admin_delete_user', user_id=user.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5">No users found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        {# --- 2. Manage Lecturers --- #}
        <h2 class="mt-5 mb-3">Manage Lecturers</h2>
        <div class="col-12">
            <div class="card dashboard-card p-4 shadow">
                <div class="card-body">
                    <h5 class="card-title">All Registered Lecturers</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Staff ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lecturer in lecturers %}
                                <tr>
                                    <td>{{ lecturer.id }}</td>
                                    <td>{{ lecturer.fullname }}</td> 
                                    <td>{{ lecturer.email }}</td>
                                    <td>{{ lecturer.staff_id }}</td> 
                                    <td>
                                        <a href="{{ url_for('admin_edit_lecturer', lecturer_id=lecturer.id) }}" class="btn btn-warning btn-sm me-2">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        <form action="{{ url_for('admin_delete_lecturer', lecturer_id=lecturer.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this lecturer?');">
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5">No lecturers found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>

        {# --- 3. Manage Voters (Read-only) --- #}
        <h2 class="mt-5 mb-3">Manage Voters</h2>
        <div class="col-12">
            <div class="card dashboard-card p-4 shadow">
                <div class="card-body">
                    <h5 class="card-title">Users Who Have Voted</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Full Name</th>
                                    <th>Status</th> 
                                </tr>
                            </thead>
                            <tbody>
                                {% for voter in voters %}
                                <tr>
                                    <td>{{ voter.id }}</td>
                                    <td>{{ voter.username }}</td>
                                    <td>{{ voter.email }}</td>
                                    <td>{{ voter.fullname }}</td>
                                    <td>
                                        <span class="badge bg-success">Voted</span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5">No voters found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>

        {# --- 4. Manage Dues Payers (Read-only) --- #}
        <h2 class="mt-5 mb-3">Manage Dues Payers</h2>
        <div class="col-12">
            <div class="card dashboard-card p-4 shadow">
                <div class="card-body">
                    <h5 class="card-title">Users Who Have Paid Dues</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Full Name</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dues_payer in dues_payers %}
                                <tr>
                                    <td>{{ dues_payer.id }}</td>
                                    <td>{{ dues_payer.username }}</td>
                                    <td>{{ dues_payer.email }}</td>
                                    <td>{{ dues_payer.fullname }}</td>
                                    <td>
                                        <span class="badge bg-info text-dark">Paid Dues</span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5">No dues payers found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>

        {# --- 5. Manage Electoral Candidates (FIXED ERROR) --- #}
        <h2 class="mt-5 mb-3">Manage Electoral Candidates</h2>
        <div class="col-12">
            <div class="card dashboard-card p-4 shadow">
                <div class="card-body">
                    <h5 class="card-title">Electoral Candidates</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Candidate Name</th>
                                    <th>Position</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for candidate in candidates %}
                                <tr>
                                    <td>{{ candidate.id }}</td>
                                    {# FIXED: Changed from candidate.user.fullname to candidate.fullname to prevent UndefinedError #}
                                    <td>{{ candidate.fullname }}</td> 
                                    <td>{{ candidate.position }}</td> 
                                    <td>
                                        {# FIXED: Changed endpoint from 'admin_edit_candidate' to 'edit_candidate' #}
                                        <a href="{{ url_for('edit_candidate', candidate_id=candidate.id) }}" class="btn btn-warning btn-sm me-2">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        {# FIXED: Changed endpoint from 'admin_delete_candidate' to 'delete_candidate' #}
                                        <form action="{{ url_for('delete_candidate', candidate_id=candidate.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this candidate?');">
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4">No candidates found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{# ========================================== #}
{# Modals start here #}
{# ========================================== #}

{# Modal 1: Registered Users #}
<div class="modal fade" id="modalOne" tabindex="-1" aria-labelledby="modalOneLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalOneLabel">üßë‚Äçüíº Registered Users (Students)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            {% if users %}
          <div class="table-responsive">
          <table class="table table-striped modal-table">
            <thead>
              <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Reg No</th>
                <th>Phone</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
                <tr>
                  <td>{{ user.fullname if user.fullname else 'N/A' }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.regno if user.regno else 'N/A' }}</td>
                  <td>{{ user.phone if user.phone else 'N/A' }}</td> 
                </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
            {% else %}
            <p class="text-muted text-center">No registered users found.</p>
            {% endif %}
        </div>
      </div>
    </div>
</div>

{# Modal 2: Voters #}
<div class="modal fade" id="modalTwo" tabindex="-1" aria-labelledby="modalTwoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTwoLabel">üó≥Ô∏è Users Who Voted</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            {% if voters %}
          <div class="table-responsive">
          <table class="table table-striped modal-table">
            <thead>
              <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Reg No</th>
              </tr>
            </thead>
            <tbody>
              {% for voter in voters %}
                <tr>
                  <td>{{ voter.fullname if voter.fullname else 'N/A' }}</td>
                  <td>{{ voter.email }}</td>
                  <td>{{ voter.regno if voter.regno else 'N/A' }}</td> 
                </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
            {% else %}
            <p class="text-muted text-center">No voters found.</p>
            {% endif %}
        </div>
      </div>
    </div>
</div>

{# Modal 3: Dues Payers #}
<div class="modal fade" id="modalThree" tabindex="-1" aria-labelledby="modalThreeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalThreeLabel">üí∞ Departmental Dues Payers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            {% if dues_payers %}
          <div class="table-responsive">
          <table class="table table-striped modal-table">
            <thead>
              <tr>
                <th>Full Name</th>
                <th>Reg No</th>
                <th>Sessions Paid</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for user in dues_payers %}
                {# Assuming the first dues record is sufficient for this modal #}
                {% set record = user.adminadddues|first if user.adminadddues is iterable %}
                <tr>
                  <td>{{ user.fullname if user.fullname else 'N/A' }}</td>
                  <td>{{ user.regno if user.regno else 'N/A' }}</td> 
                  <td>{{ record.sessions_paid if record and record.sessions_paid else 'N/A' }}</td>
                  <td>{{ record.date_filled.strftime("%Y-%m-%d") if record and record.date_filled else 'N/A' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
            {% else %}
            <p class="text-muted text-center">No departmental dues payers found.</p>
            {% endif %}
        </div>
      </div>
    </div>
</div>

{# Modal: Registered Lecturers (NEW) #}
<div class="modal fade" id="modalLecturers" tabindex="-1" aria-labelledby="modalLecturersLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLecturersLabel">üë©‚Äçüè´ Registered Lecturers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if lecturers %}
                <div class="table-responsive">
                    <table class="table table-striped modal-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Staff ID</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>State of Origin</th>
                                <th>LGA</th>
                                <th>Home Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lecturer in lecturers %}
                            <tr>
                                <td>{{ lecturer.id }}</td>
                                <td>{{ lecturer.fullname }}</td> {# Assuming 'fullname' attribute #}
                                <td>{{ lecturer.email }}</td>
                                <td>{{ lecturer.staff_id }}</td>
                                <td>{{ lecturer.department if lecturer.department else 'N/A' }}</td>
                                <td>{{ lecturer.phone_number if lecturer.phone_number else 'N/A' }}</td>
                                <td>{{ lecturer.state_of_origin if lecturer.state_of_origin else 'N/A' }}</td>
                                <td>{{ lecturer.lga if lecturer.lga else 'N/A' }}</td>
                                <td>{{ lecturer.home_address if lecturer.home_address else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No lecturers have created an account yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Admin Logout Button #}
<div class="container text-center mt-5 mb-5">
    <a href="{{ url_for('admin_logout') }}" class="btn btn-danger btn-lg shadow">
        <i class="bi bi-box-arrow-right"></i> Admin Logout
    </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
